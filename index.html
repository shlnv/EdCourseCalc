<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calc</title>
</head>
<body>
<div>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300&family=Pathway+Gothic+One&display=swap');

        #calcWrapper {
            visibility: hidden;
            background-color: rgba(255, 255, 255, 1);
            font-family: 'Montserrat', sans-serif;
            width: 1216px;
            border-radius: 16px;
            box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.1);
            padding: 23px 40px 40px 23px;;
        }

        #calcHeader {
            display: inline-block;
            color: rgba(134, 68, 215, 1);
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            text-align: left;
            vertical-align: top;
            letter-spacing: .15rem;
            margin-bottom: 5px;
        }

        #calcLogo {
            position: relative;
            display: inline-block;
            width: 187px;
            height: 95px;
            float: right;
        }

        #calcSubHeader {
            display: inline-block;
            margin-top: 10px;
            margin-bottom: 20px;
            color: rgba(75, 80, 97, 1);
            letter-spacing: .15rem;
        }

        #SLSwitchWrapper {
            font-size: 0;
        }

        #SLChoiceText {
            display: inline-block;
            font-size: 20px;
            color: rgba(75, 80, 97, 1);
            width: 347px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #SLYesButton {
            display: inline-block;
            text-align: center;
            font-size: 20px;
            width: 120px;
            height: 46px;
            border: 3px solid rgba(255, 210, 0, 1);
            border-radius: 25px 0 0 25px;
            margin-right: 0;
            margin-left: 50px;
            line-height: 3.1em;
        }

        #SLNoButton {
            display: inline-block;
            text-align: center;
            font-size: 20px;
            width: 120px;
            height: 46px;
            border: 3px solid rgba(255, 210, 0, 1);
            border-radius: 0 25px 25px 0;
            margin-left: 0;
            line-height: 3.1em;
        }

        .calcTextInButton {
            position: relative;
            top: -0.35em
        }

        .calcButton:hover {
            background-color: orange;
            cursor: pointer;
        }

        .calcButton:active {
            background-color: darkorange;
        }

        .calcButtonPressed {
            background-color: rgba(255, 210, 0, 1);
        }

        #chooseCourseWrapper {
            visibility: hidden;
        }

        .chooseCourseButton {
            font-size: 20px;
            width: 240px;
            height: 46px;
            border: 3px solid rgba(255, 210, 0, 1);
            border-radius: 25px;
            background-color: rgba(255, 255, 255, 1);
        }

        .chooseCourseButton:hover {
            background-color: orange;
            cursor: pointer;
        }

        .chooseCourseButton:active {
            background-color: darkorange;
        }

        .chooseCourseButtonSelected {
            background-color: rgba(255, 210, 0, 1);
        }

        .chooseCourseButtonNotSelected {
            border: 3px solid rgba(221, 221, 221, 1);
            color: rgba(221, 221, 221, 1);
        }

    </style>

    <div id="calcWrapper">
        <h1 id="calcHeader">КАЛЬКУЛЯТОР КУРСА</h1>
        <img src="https://downloader.disk.yandex.ru/preview/75ead0cec289444e37160f97fbed503e13b7560713b4b25ab4d6efcd9a5f06e7/6325ecbe/6BT_65iy4PXvu2PF0YpJ6D14QMkfvcNQtXs-2_Y00s8dlFBC17CHsnKS2hMMDK46hUoqW2j11FiUO_Ru2YXPJw%3D%3D?uid=0&filename=logo-04.png&disposition=inline&hash=&limit=0&content_type=image%2Fpng&owner_uid=0&tknv=v2&size=2048x2048"
             alt="logo"
             id="calcLogo">
        <br>
        <h3 id="calcSubHeader">ВЫБЕРИТЕ НУЖНЫЕ ВАМ ХАРАКТЕРИСТИКИ</h3>
        <br>
        <div id="SLSwitchWrapper">
            <span id="SLChoiceText">Разработка курса в соответствии с вашим фирменным стилем?</span>
            <div id="SLYesButton" class="calcButton">
                <div class="calcTextInButton">ДА</div>
            </div>
            <div id="SLNoButton" class="calcButton">
                <div class="calcTextInButton">НЕТ</div>
            </div>
        </div>
        <div id="chooseCourseWrapper">
            <span>Какой курс вам нужен?</span>
            <button class="chooseCourseButton" id="longReadButton">ЛОНГРИД</button>
            <button class="chooseCourseButton" id="videoCourseButton">ВИДЕОКУРС</button>
            <button class="chooseCourseButton" id="trainerButton">ТРЕНАЖЁР</button>
        </div>
    </div>

    <script>
        console.log(window.navigator.userAgent);

        const calc = () => {

            class Data {
                #url;
                #data;
                #profitMultiplier;
                #constantExpenses;
                #constantExpensesPure;
                #constantExpensesSL;
                #courseBranding;
                #constantExpensesRUB;
                #constantExpensesUSD;
                #constantExpensesKZT;
                #constantExpensesSLRUB;
                #constantExpensesSLUSD;
                #constantExpensesSLKZT;
                #units;
                #bankOfRussiaAPI;
                #usd;
                #kzt;

                constructor() {
                    this.#url = 'https://script.google.com/macros/s/AKfycbyvuqVCLoujMoF4fEQIVzlx78E3DVLgD9fEfxKTaG2D-Z5ctCMPewsrsQCl4OH_qJaC/exec';
                    this.#bankOfRussiaAPI = 'https://www.cbr-xml-daily.ru/daily_json.js';
                }

                getFromAPI = async () => {
                    this.#data = await this.fetchData(this.#url);
                    this.#profitMultiplier = +this.#data[0][0].amount;
                    this.#constantExpenses = +this.#data[0][1].amount;
                    this.#constantExpensesPure = this.#constantExpenses;
                    this.#courseBranding = +this.#data[0][2].amount;
                    this.#constantExpensesSL = this.#constantExpenses + this.#courseBranding;
                    this.#units = this.#data[1];
                    this.#units.forEach((unit) => {
                        if (unit.toolSwitcher === '')
                            unit.toolSwitcher = false;
                        unit.name = unit.nameRiseNameBase;
                        unit.longread = +unit.longread;
                        unit.videocourse = +unit.videocourse;
                        unit.trainer = +unit.trainer;
                        unit.RisePossibility = +unit.RisePossibility;
                        unit.SLPossibility = +unit.SLPossibility;
                        unit.TildaPossibility = +unit.TildaPossibility;
                    })
                    return true;
                }

                fetchData = async (url) => {
                    const response = await fetch(url)
                    const data = await response.json();
                    if (data.ok) {
                        return data.data;
                    } else {
                        return new Error('server is not responding')
                    }
                }

                fetchExchangeRates = async () => {
                    const data = await fetch(this.#bankOfRussiaAPI);
                    const rates = await data.json();
                    this.#usd = +rates.Valute.USD.Value;
                    this.#kzt = +rates.Valute.KZT.Value;
                    return true;
                }

                getUSDrate = () => {
                    return this.#usd;
                }

                getKZTrate = () => {
                    return this.#kzt;
                }

                setPrices = () => {
                    this.#units.forEach((unit) => {
                        unit.price = unit.priceRiseBasePrise;
                        unit.RUBprice = unit.price;
                        unit.USDprice = unit.RUBprice / this.#usd;
                        unit.KZTprice = unit.RUBprice / this.#kzt;
                        if (unit.priceSL === '') {
                            unit.priceSL = false;
                        } else {
                            unit.RUBpriceSL = unit.priceSL;
                            unit.USDpriceSL = unit.RUBpriceSL / this.#usd;
                            unit.KZTpriceSL = unit.RUBpriceSL / this.#usd;
                        }
                        if (unit.priceRiseBasePrise === '') {
                            unit.priceRiseBasePrise = false;
                        } else {
                            unit.RUBpriceRise = unit.priceRiseBasePrise;
                            unit.USDpriceRise = unit.RUBpriceRise / this.#usd;
                            unit.KZTpriceRise = unit.RUBpriceRise / this.#usd;
                        }
                        if (unit.priceTilda === '') {
                            unit.priceTilda = false;
                        } else {
                            unit.RUBpriceTilda = unit.priceTilda;
                            unit.USDpriceTilda = unit.RUBpriceTilda / this.#usd;
                            unit.KZTpriceTilda = unit.RUBpriceTilda / this.#usd;
                        }
                    });
                    this.#constantExpensesRUB = this.#constantExpenses;
                    this.#constantExpensesUSD = this.#constantExpensesRUB / this.#usd;
                    this.#constantExpensesKZT = this.#constantExpensesRUB / this.#kzt;
                    this.#constantExpensesSLRUB = this.#constantExpensesSL;
                    this.#constantExpensesSLUSD = this.#constantExpensesSLRUB / this.#usd;
                    this.#constantExpensesSLKZT = this.#constantExpensesSLRUB / this.#kzt;
                    console.log(this.#units);
                }

                setSLPrices = (cur) => {
                    this.#units.forEach((unit) => {
                        if (unit.SLPossibility) {
                            unit.price = unit.priceSL;
                        }
                    })
                }

                setRisePrices = () => {
                    this.#units.forEach((unit) => {
                        if (unit.priceSL) {
                            unit.price = unit.priceRise;
                        }
                    })
                }


                setCurrency = (cur) => {
                    switch (cur) {
                        case 'USD':
                            this.#units.forEach((unit) => {
                                unit.price = unit.USDprice;
                                if (unit.priceSL) {
                                    unit.priceSL = unit.USDpriceSL;
                                }
                            });
                            this.#constantExpenses = this.#constantExpensesUSD;
                            this.#constantExpensesSL = this.#constantExpensesSLUSD;
                        case 'KZT':
                            this.#units.forEach((unit) => {
                                unit.price = unit.KZTprice;
                                if (unit.priceSL) {
                                    unit.priceSL = unit.KZTpriceSL;
                                }
                            })
                            this.#constantExpenses = this.#constantExpensesKZT;
                            this.#constantExpensesSL = this.#constantExpensesSLKZT;
                        case 'RUB':
                            this.#units.forEach((unit) => {
                                unit.price = unit.RUBprice;
                                if (unit.priceSL) {
                                    unit.priceSL = unit.RUBpriceSL;
                                }
                            })
                            this.#constantExpenses = this.#constantExpensesRUB;
                            this.#constantExpensesSL = this.#constantExpensesSLRUB;

                    }
                }

                getProfitMultiplier = () => {
                    return this.#profitMultiplier;
                }

                getConstantExpenses = () => {
                    return this.#constantExpenses;
                }

                getUnits = () => {
                    return this.#units;
                }

                sendOrder = async (cart, userData) => {

                    class Order {
                        constructor(email, units, totalPrice) {
                            this.email = email
                            this.units = units;
                            this.totalPrice = totalPrice;
                        }
                    }

                    class OrderedUnit {
                        constructor(id, name, purePrice, priceWithExpenses) {
                            this.id = id;
                            this.name = name;
                            this.purePrice = purePrice;
                            this.priceWithExpenses = priceWithExpenses;
                        }
                    }

                    if (cart.length > 0) {
                        let total = 0;
                        const orderedUnits = cart.map((el) => {
                            total += el.fullPrice;
                            return new OrderedUnit(el.id, el.name, el.price.toFixed(2), el.fullPrice.toFixed(2));
                        })
                        const dto = new Order(userData, orderedUnits, total.toFixed(2));
                        const response = await fetch(this.#url, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify(dto)
                        })
                    }
                }
            };

            class UseCases {
                #data;
                #selected;
                #cart;
                #total;
                #userData;
                #slSwitch;
                #currency;

                constructor(data) {
                    this.#data = data;
                    this.#cart = [];
                    this.#selected = [];
                    this.#total = 0;
                    this.#slSwitch = false;
                    this.#currency = 'RUB';
                }

                oneUnitFullPriceFormula = (x) => {
                    return (x.price + this.#data.getConstantExpenses() / this.#cart.length) * (1 + +this.#data.getProfitMultiplier());
                }

                slSwitchOn = () => {
                    this.#slSwitch = true;
                    }


                slSwitchOff = () => {
                        this.#slSwitch = false;
                    }


                addToCart = (e) => {
                    const unit = this.#data.getUnits()[+e.target.dataset.index];
                    this.#cart.push(unit);
                    this.setTotal();
                    return this.#cart;
                };

                selectFromCart = (e) => {
                    this.#selected.push(e.target.dataset.index);
                }

                submit = (func) => {
                    func(this.#cart, this.#userData);
                    return this.clearCart();
                };

                enterUserData = (userData) => {
                    this.#userData = userData;
                    return this.submit(this.#data.sendOrder);
                }

                removeOneFromCart = (e) => {
                    this.#cart.splice(+e.target.dataset.index, 1);
                    this.setTotal();
                    return this.#cart;
                }

                clearCart = () => {
                    this.#cart = [];
                    this.setTotal();
                    return this.#cart;
                }

                setTotal = () => {
                    this.#total = 0;
                    this.#cart.forEach((el) => {
                        el.fullPrice = this.oneUnitFullPriceFormula(el);
                        this.#total += el.fullPrice;
                    })
                }

                getCart = () => {
                    return this.#cart;
                }

                getSelected = () => {
                    return this.#selected;
                }

            };

            class Draw {
                #useCases

                constructor(useCases) {
                    this.#useCases = useCases;
                    this.chooseCourseWrapper = document.getElementById('chooseCourseWrapper');
                    this.SLYesButton = document.getElementById('SLYesButton');
                    this.SLNoButton = document.getElementById('SLNoButton');
                    this.SLYesButton.addEventListener('click', () => {
                        this.SLYesButton.classList.remove('calcButton');
                        this.SLYesButton.classList.add('calcButtonPressed');
                        this.SLNoButton.classList.remove('calcButtonPressed');
                        this.SLNoButton.classList.add('calcButton');
                        this.chooseCourseWrapper.style.visibility = 'visible';
                        useCases.slSwitchOn();
                    });
                    this.SLNoButton.addEventListener('click', () => {
                        this.SLNoButton.classList.remove('calcButton');
                        this.SLNoButton.classList.add('calcButtonPressed');
                        this.SLYesButton.classList.remove('calcButtonPressed');
                        this.SLYesButton.classList.add('calcButton');
                        this.chooseCourseWrapper.style.visibility = 'visible';
                        useCases.slSwitchOff();
                    });
                    this.longReadButton = document.getElementById('longReadButton');
                    this.videoCourseButton = document.getElementById('videoCourseButton');
                    this.trainerButton = document.getElementById('trainerButton');
                    this.longReadButton.addEventListener('click', () => {
                        this.longReadButton.classList.remove('chooseCourseButtonNotSelected');
                        this.longReadButton.classList.add('chooseCourseButtonSelected');
                        this.videoCourseButton.classList.remove('chooseCourseButtonSelected');
                        this.videoCourseButton.classList.add('chooseCourseButtonNotSelected');
                        this.trainerButton.classList.remove('chooseCourseButtonSelected');
                        this.trainerButton.classList.add('chooseCourseButtonNotSelected');
                    });
                    this.videoCourseButton.addEventListener('click', () => {
                        this.videoCourseButton.classList.remove('chooseCourseButtonNotSelected');
                        this.videoCourseButton.classList.add('chooseCourseButtonSelected');
                        this.longReadButton.classList.remove('chooseCourseButtonSelected');
                        this.longReadButton.classList.add('chooseCourseButtonNotSelected');
                        this.trainerButton.classList.remove('chooseCourseButtonSelected');
                        this.trainerButton.classList.add('chooseCourseButtonNotSelected');
                    });
                    this.trainerButton.addEventListener('click', () => {
                        this.trainerButton.classList.remove('chooseCourseButtonNotSelected');
                        this.trainerButton.classList.add('chooseCourseButtonSelected');
                        this.longReadButton.classList.remove('chooseCourseButtonSelected');
                        this.longReadButton.classList.add('chooseCourseButtonNotSelected');
                        this.videoCourseButton.classList.remove('chooseCourseButtonSelected');
                        this.videoCourseButton.classList.add('chooseCourseButtonNotSelected');
                    });
                }

                openCalc = () => {
                    const calc = document.getElementById('calcWrapper');
                    calc.style.visibility = 'visible';
                }

//TODO
                static serverError = (e) => {
                    console.log(e);
                }

//                 constructor(useCases) {
//                     this.#useCases = useCases;
//                     this.clearButton = document.getElementById('clearButton');
//                     this.submitCalc = document.getElementById('submitCalc');
//                     this.submitCalc.addEventListener('click', this.sendCart);
//                     this.clearButton.addEventListener('click', this.clearCartBtn);
//                 }
//
//                 createUnitList = (units) => {
//                     const unitList = document.getElementById('unitList');
//                     units.forEach((unit, i) => {
//                         const element = document.createElement('div');
//                         element.id = unit.id;
//                         element.dataset.index = i;
//                         element.title = unit.text;
//                         element.className = 'unitAtList';
//                         element.addEventListener('click', this.clickOnUnit);
//                         const textContent = document.createTextNode(unit.name);
//                         element.appendChild(textContent);
//                         unitList.append(element);
//                     })
//                 }
//
//                 clickOnUnit = (e) => {
//                     const cart = this.#useCases.addToCart(e);
//                     this.renderCart(cart);
//                 }
//
//                 removeOneFromCart = (e) => {
//                     const cart = this.#useCases.removeOneFromCart(e);
//                     this.renderCart(cart);
//                 }
//
//                 sendCart = () => {
//                     const calcWrapper = document.getElementById('calcWrapper');
//                     calcWrapper.classList.add('loadingCalc');
//                     const cart = this.#useCases.enterUserData(prompt('Введите ваш телефон или e-mail', ''));
//                     alert('Наш сотрудник свяжется с вами в ближайшее время');
//                     calcWrapper.classList.remove('loadingCalc');
//                     this.renderCart(cart);
//                 }
//
//                 clearCartBtn = () => {
//                     const cart = this.#useCases.clearCart();
//                     this.renderCart(cart);
//                 }
//
//                 renderCart = (cart) => {
//                     let total = 0;
//                     const cartUnits = document.getElementById('cartUnits');
//                     const cartPrices = document.getElementById('cartPrices');
//                     cartUnits.innerHTML = '';
//                     cartPrices.innerHTML = '';
//                     cart.forEach((unit, i) => {
//                         total += unit.fullPrice;
//                         const inCartLineUnit = document.createElement('div');
//                         inCartLineUnit.className = 'inCartLineUnit';
//                         inCartLineUnit.dataset.index = i;
//                         inCartLineUnit.addEventListener('mouseover', this.highlightLine);
//                         inCartLineUnit.addEventListener('mouseleave', this.removeHighlight)
//                         const inCartLinePrice = document.createElement('div');
//                         inCartLinePrice.dataset.index = i;
//                         inCartLinePrice.className = 'inCartLinePrice';
//                         inCartLinePrice.addEventListener('mouseover', this.highlightLine);
//                         inCartLinePrice.addEventListener('mouseleave', this.removeHighlight)
//                         const textContentUnit = document.createTextNode(unit.name);
//                         const textContentPrice = document.createTextNode(unit.fullPrice);
//                         const deleteUnit = document.createElement('div');
//                         deleteUnit.className = 'delete';
//                         deleteUnit.addEventListener('click', this.removeOneFromCart);
//                         deleteUnit.dataset.index = i;
//                         const textContentDelete = document.createTextNode('x');
//                         deleteUnit.appendChild(textContentDelete);
//                         inCartLineUnit.appendChild(textContentUnit);
//                         inCartLineUnit.appendChild(deleteUnit);
//                         inCartLinePrice.appendChild(textContentPrice);
//                         cartUnits.appendChild(inCartLineUnit);
//                         cartPrices.appendChild(inCartLinePrice);
//                     })
//                     const totalSum = document.getElementById('totalSum');
//                     const textContentTotal = document.createTextNode(total.toFixed(2).toString());
//                     totalSum.innerHTML = '';
//                     totalSum.appendChild(textContentTotal);
//                 };
//
//                 whatColumn = (e) => {
//                     const el1 = e.target;
//                     let el2;
//                     const index = +el1.dataset.index;
//                     if (el1.classList.contains('inCartLineUnit')) {
//                         const cartPrices = document.querySelectorAll('.inCartLinePrice');
//                         el2 = cartPrices.item(index + 1);
//                     } else {
//                         const cartUnits = document.querySelectorAll('.inCartLineUnit');
//                         el2 = cartUnits.item(index + 1);
//                     }
//                     return [el1, el2];
//                 }
//
//                 highlightLine = (e) => {
//                     const [el1, el2] = this.whatColumn(e);
//                     el1.classList.add('highlightUnit');
//                     el2.classList.add('highlightUnit');
//                 }
//
//                 removeHighlight = (e) => {
//                     const [el1, el2] = this.whatColumn(e);
//                     el1.classList.remove('highlightUnit');
//                     el2.classList.remove('highlightUnit');
//                 }
// //TODO
//                 static serverError = (e) => {
//                     console.log(e);
//                 }
            };

            const run = async () => {
                let success = false;
                const data = new Data();
                try {
                    success = await data.getFromAPI();
                } catch (e) {
                    console.log('caught data.getFromAPI()');
                    Draw.serverError(e);
                }
                if (success) {
                    const useCases = new UseCases(data);
                    const draw = new Draw(useCases);
                    draw.openCalc();
                    // draw.createUnitList(data.getUnits());
                }
                try {
                    if (success) {
                        success = await data.fetchExchangeRates()
                    }
                } catch (e) {
                    console.log('caught data.fetchExchangeRates() error')
                    Draw.serverError(e);
                }
                if (success) {
                    await data.setPrices();
                }
            }
            run();
        };
        calc();

    </script>
</div>
</body>
</html>